# æ²™ç›’ä»£ç æ‰§è¡Œç³»ç»Ÿ

ä¸€ä¸ªåŸºäºDockerå®¹å™¨çš„å®‰å…¨ä»£ç æ‰§è¡Œæ²™ç›’ç³»ç»Ÿï¼Œä½¿ç”¨FastAPIæä¾›REST APIæ¥å£ã€‚æ¯æ¬¡ä»£ç æ‰§è¡Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„éš”ç¦»å®¹å™¨ï¼Œæ‰§è¡Œå®Œæˆåè‡ªåŠ¨é”€æ¯ï¼Œç¡®ä¿å®‰å…¨æ€§å’Œèµ„æºéš”ç¦»ã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
sandbox/
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â””â”€â”€ main.py            # FastAPI ä¸»åº”ç”¨
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ test_unit.py       # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ test_sandbox.py    # ç®€å•åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ test_comprehensive.py  # ç»¼åˆé›†æˆæµ‹è¯•
â”‚   â””â”€â”€ test_benchmark.py  # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”œâ”€â”€ scripts/               # è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ build_and_run.sh  # æ„å»ºå’Œè¿è¡Œè„šæœ¬
â”‚   â””â”€â”€ run_tests.py       # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ docker/                # Docker ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ Dockerfile         # ä¸»æœåŠ¡ Dockerfile
â”‚   â””â”€â”€ Dockerfile.executor # æ‰§è¡Œå™¨ Dockerfile
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â””â”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡

- **ä¸»æœåŠ¡å®¹å™¨**: è¿è¡ŒFastAPIåº”ç”¨ï¼Œå¤„ç†APIè¯·æ±‚
- **æ‰§è¡Œå™¨å®¹å™¨**: æ¯æ¬¡ä»£ç æ‰§è¡Œæ—¶åŠ¨æ€åˆ›å»ºçš„éš”ç¦»å®¹å™¨
- **Docker API**: ç”¨äºç®¡ç†æ‰§è¡Œå™¨å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- æ¯æ¬¡æ‰§è¡Œä½¿ç”¨å…¨æ–°çš„å®¹å™¨å®ä¾‹
- å®¹å™¨èµ„æºé™åˆ¶ï¼ˆå†…å­˜128MBï¼ŒCPUé™åˆ¶ï¼‰
- ç¦ç”¨ç½‘ç»œè®¿é—®
- ä½¿ç”¨érootç”¨æˆ·æ‰§è¡Œä»£ç 
- æ‰§è¡Œå®Œæˆåè‡ªåŠ¨é”€æ¯å®¹å™¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ä½¿ç”¨æ„å»ºè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä¸€é”®æ„å»ºå’Œè¿è¡Œ
./scripts/build_and_run.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨æ„å»º

```bash
# 1. æ„å»ºæ‰§è¡Œå™¨é•œåƒ
docker build -f docker/Dockerfile.executor -t sandbox-executor .

# 2. æ„å»ºä¸»æœåŠ¡é•œåƒ
docker build -f docker/Dockerfile -t sandbox-api .

# 3. è¿è¡Œä¸»æœåŠ¡
docker run -d \
    --name sandbox-api \
    -p 16009:16009 \
    -v /var/run/docker.sock:/var/run/docker.sock \
    --rm \
    sandbox-api
```

## ğŸ“– APIä½¿ç”¨

### æ‰§è¡Œä»£ç 

```bash
curl -X POST "http://localhost:16009/execute" \
     -H "Content-Type: application/json" \
     -d '{
       "code": "print('Hello, Sandbox!')",
       "timeout": 30
     }'
```

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "output": "Hello, Sandbox!\n",
  "exit_code": 0,
  "container_id": "abc123def456"
}
```

## ğŸ§ª æµ‹è¯•

### å¿«é€Ÿæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./scripts/run_tests.py

# ç­‰å¾…æœåŠ¡å¯åŠ¨åè¿è¡Œæµ‹è¯•
./scripts/run_tests.py --wait

# åªè¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•
./scripts/run_tests.py --unit          # å•å…ƒæµ‹è¯•
./scripts/run_tests.py --simple        # ç®€å•åŠŸèƒ½æµ‹è¯•
./scripts/run_tests.py --integration   # é›†æˆæµ‹è¯•
./scripts/run_tests.py --benchmark     # æ€§èƒ½åŸºå‡†æµ‹è¯•
```

### æµ‹è¯•ç±»å‹è¯´æ˜

#### 1. å•å…ƒæµ‹è¯• (`test_unit.py`)
- æµ‹è¯•SandboxExecutorç±»çš„æ ¸å¿ƒåŠŸèƒ½
- ä½¿ç”¨Mockå¯¹è±¡æ¨¡æ‹ŸDocker API
- ä¸éœ€è¦å®é™…çš„Dockerç¯å¢ƒ
- å¿«é€Ÿæ‰§è¡Œï¼Œé€‚åˆå¼€å‘é˜¶æ®µ

#### 2. ç®€å•åŠŸèƒ½æµ‹è¯• (`test_sandbox.py`)
- åŸºæœ¬çš„APIåŠŸèƒ½æµ‹è¯•
- æµ‹è¯•ä»£ç æ‰§è¡Œã€é”™è¯¯å¤„ç†ç­‰
- éœ€è¦è¿è¡Œä¸­çš„æ²™ç›’æœåŠ¡

#### 3. é›†æˆæµ‹è¯• (`test_comprehensive.py`)
- å…¨é¢çš„ç³»ç»Ÿé›†æˆæµ‹è¯•
- åŒ…å«å®‰å…¨æ€§ã€å¹¶å‘æ€§ã€é”™è¯¯å¤„ç†ç­‰
- æµ‹è¯•çœŸå®çš„å®¹å™¨åˆ›å»ºå’Œé”€æ¯
- éªŒè¯èµ„æºé™åˆ¶å’Œéš”ç¦»æ•ˆæœ

#### 4. æ€§èƒ½åŸºå‡†æµ‹è¯• (`test_benchmark.py`)
- ç³»ç»Ÿæ€§èƒ½å’Œè´Ÿè½½æµ‹è¯•
- æµ‹è¯•å¹¶å‘æ‰§è¡Œèƒ½åŠ›
- å®¹å™¨å¯åŠ¨å¼€é”€åˆ†æ
- CPUå’Œå†…å­˜å¯†é›†å‹ä»»åŠ¡æ€§èƒ½
- ç”Ÿæˆè¯¦ç»†çš„æ€§èƒ½æŠ¥å‘Šå’Œå›¾è¡¨

### æµ‹è¯•ç»“æœ

æ€§èƒ½æµ‹è¯•ä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š
- `benchmark_results.json` - è¯¦ç»†çš„æ€§èƒ½æ•°æ®
- `benchmark_results.png` - æ€§èƒ½å›¾è¡¨

### æŒç»­é›†æˆ

```bash
# åœ¨CIç¯å¢ƒä¸­è¿è¡Œ
./scripts/run_tests.py --no-service-check --unit
```

## ğŸ“‹ ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs -f sandbox-api

# åœæ­¢æœåŠ¡
docker stop sandbox-api

# æ¸…ç†æ‰€æœ‰ç›¸å…³é•œåƒ
docker rmi sandbox-api sandbox-executor
```

## ğŸ”§ é…ç½®é€‰é¡¹

- `timeout`: ä»£ç æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤30ï¼‰
- å†…å­˜é™åˆ¶: 128MB
- CPUé™åˆ¶: 50%
- ç½‘ç»œ: ç¦ç”¨

## ğŸ“¦ æ”¯æŒçš„PythonåŒ…

æ‰§è¡Œå™¨å®¹å™¨é¢„è£…äº†å¸¸ç”¨çš„PythonåŒ…ï¼š
- pandas
- numpy
- matplotlib
- requests
- jupyter
- ipython